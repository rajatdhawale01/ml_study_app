{% extends "layout.html" %}
{% block content %}
<!-- Hero -->
<section
  class="relative overflow-hidden rounded-2xl mb-6 border"
  style="background: radial-gradient(1200px 400px at 20% -10%, rgba(79,70,229,0.15), transparent),
                 radial-gradient(900px 300px at 90% 0%, rgba(236,72,153,0.12), transparent);">
  <div class="relative z-10 px-5 py-8 sm:px-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Data Preparation — Theory (Deep Dive)</h1>
        <p class="text-gray-600 mt-1 dark:text-gray-300">
          Cleaning · Preprocessing · Feature Engineering · Data Types · Validation · Leakage · Robustness
        </p>
      </div>
      <div class="flex items-center gap-2">
        <!-- Theme toggle -->
        <button id="themeToggle"
          class="rounded-full border px-3 py-1.5 text-sm hover:shadow transition bg-white/70 backdrop-blur dark:bg-gray-900">
          <span class="inline dark:hidden">🌙 Dark</span>
          <span class="hidden dark:inline">☀️ Light</span>
        </button>
      </div>
    </div>

    <!-- Search + progress -->
    <div class="mt-5 grid grid-cols-1 lg:grid-cols-3 gap-3">
      <div class="lg:col-span-2">
        <div class="relative max-w-xl">
          <input id="searchInput" placeholder="Search topics… (e.g., encoding, leakage, PCA)"
                 class="w-full rounded-xl border px-4 py-2.5 pr-10 outline-none focus:ring-2 focus:ring-indigo-400
                        bg-white/80 backdrop-blur dark:bg-gray-900 dark:border-gray-700 dark:placeholder-gray-400" />
          <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400">⌘K</div>
        </div>
        <p class="text-xs text-gray-500 mt-2">
          Tips: Press <span class="font-medium">⌘/Ctrl + K</span> to focus search • Click a section to expand • Hover cards for tilt
        </p>
      </div>
      <div class="bg-white/70 dark:bg-gray-900 border rounded-xl p-3">
        <div class="flex items-center justify-between text-sm">
          <span class="font-medium">Progress</span>
          <div class="space-x-2">
            <button id="markAll" class="text-xs border px-2 py-0.5 rounded hover:bg-gray-50 dark:hover:bg-gray-800">Mark all</button>
            <button id="resetAll" class="text-xs border px-2 py-0.5 rounded hover:bg-gray-50 dark:hover:bg-gray-800">Reset</button>
          </div>
        </div>
        <div class="mt-2 h-2 rounded-full bg-gray-200 dark:bg-gray-800 overflow-hidden">
          <div id="progressBar" class="h-full bg-gradient-to-r from-indigo-500 to-fuchsia-500" style="width: 0%;"></div>
        </div>
        <div id="progressText" class="text-xs text-gray-600 dark:text-gray-400 mt-1">0 of 0 completed</div>
      </div>
    </div>
  </div>

  <!-- Decorative blur orbs -->
  <div class="absolute -top-16 -left-10 h-40 w-40 rounded-full blur-3xl opacity-50"
       style="background: linear-gradient(120deg, rgba(99,102,241,0.35), rgba(236,72,153,0.35));"></div>
  <div class="absolute -bottom-16 -right-10 h-48 w-48 rounded-full blur-3xl opacity-40"
       style="background: linear-gradient(120deg, rgba(16,185,129,0.35), rgba(59,130,246,0.35));"></div>
</section>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-5">
  <!-- Sticky TOC -->
  <aside class="lg:col-span-3">
    <div class="sticky top-4 bg-white dark:bg-gray-900 border rounded-2xl p-3">
      <div class="text-sm font-semibold mb-2">On this page</div>
      <nav id="toc" class="space-y-1 text-sm">
        <!-- Populated by JS -->
      </nav>
    </div>
  </aside>

  <!-- Content -->
  <div class="lg:col-span-9 space-y-4" id="cardsGrid">
    <!-- Card template: .theory-card -->
    <section id="types" class="theory-card card rounded-2xl border bg-white p-4 shadow-sm dark:bg-gray-900 dark:border-gray-700"
             data-title="data types tabular time series text images audio categorical targets" data-order="1">
      <header class="flex items-start justify-between gap-3 cursor-pointer select-none accordion-toggle">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl grid place-items-center bg-gradient-to-br from-indigo-500 to-purple-500 text-white text-lg shadow-sm">🧱</div>
          <h2 class="text-lg font-semibold">1) Types of Data (know what you have)</h2>
        </div>
        <div class="flex items-center gap-2">
          <span class="status-badge text-[11px] text-gray-500 border rounded-full px-2 py-0.5">Unread</span>
          <span class="chev transition">▶</span>
        </div>
      </header>
      <div class="accordion-body mt-3 hidden">
        <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 space-y-1">
          <li><span class="font-medium">Tabular</span>: rows=examples, cols=features; mixed numeric/categorical.</li>
          <li><span class="font-medium">Time Series</span>: ordered; autocorrelation; avoid shuffling → future leakage.</li>
          <li><span class="font-medium">Text</span>: tokenization/embeddings; vocabulary drift over time.</li>
          <li><span class="font-medium">Images/Audio</span>: high-dimensional; augmentation & task-specific models.</li>
          <li><span class="font-medium">Categorical</span>: nominal vs ordinal; encoding choice matters.</li>
          <li><span class="font-medium">Targets</span>: binary/multi-class/multi-label/continuous → metrics & loss change.</li>
        </ul>
      </div>
    </section>

    <section id="cleaning" class="theory-card card rounded-2xl border bg-white p-4 shadow-sm dark:bg-gray-900 dark:border-gray-700"
             data-title="cleaning duplicates missing invalid values normalization dates timezones outliers" data-order="2">
      <header class="flex items-start justify-between gap-3 cursor-pointer select-none accordion-toggle">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl grid place-items-center bg-gradient-to-br from-emerald-500 to-sky-500 text-white text-lg shadow-sm">🧹</div>
          <h2 class="text-lg font-semibold">2) Cleaning (make data trustworthy)</h2>
        </div>
        <div class="flex items-center gap-2">
          <span class="status-badge text-[11px] text-gray-500 border rounded-full px-2 py-0.5">Unread</span>
          <span class="chev transition">▶</span>
        </div>
      </header>
      <div class="accordion-body mt-3 hidden">
        <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 space-y-1">
          <li>Drop exact duplicates; investigate near-duplicates (may be label leakage).</li>
          <li>Missingness: MCAR/MAR/MNAR; baseline = median (num) / mode (cat).</li>
          <li>Invalid values: negative ages, impossible timestamps → correct/remove.</li>
          <li>Normalize text & categories: trim/lower/unicode; unify synonyms (“NY” ≈ “New York”).</li>
          <li>Datetime hygiene: parse, timezone consistency; derive parts later.</li>
          <li>Outliers: clip/winsorize if they harm metrics; keep if they’re the signal (e.g., fraud).</li>
        </ul>
      </div>
    </section>

    <section id="preprocess" class="theory-card card rounded-2xl border bg-white p-4 shadow-sm dark:bg-gray-900 dark:border-gray-700"
             data-title="preprocessing fit on train scaling encoding one-hot ordinal target encoding imbalance text time series" data-order="3">
      <header class="flex items-start justify-between gap-3 cursor-pointer select-none accordion-toggle">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl grid place-items-center bg-gradient-to-br from-fuchsia-500 to-rose-500 text-white text-lg shadow-sm">🧪</div>
          <h2 class="text-lg font-semibold">3) Preprocessing (prepare features safely)</h2>
        </div>
        <div class="flex items-center gap-2">
          <span class="status-badge text-[11px] text-gray-500 border rounded-full px-2 py-0.5">Unread</span>
          <span class="chev transition">▶</span>
        </div>
      </header>
      <div class="accordion-body mt-3 hidden">
        <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 space-y-1">
          <li><span class="font-medium">Fit on train only</span>: imputer/scaler/encoder fit on train folds → apply to val/test.</li>
          <li><span class="font-medium">Scaling</span>: needed for KNN/SVM/LogReg; not for trees/forests/boosting.</li>
          <li><span class="font-medium">Encoding</span>:
            <ul class="list-disc pl-6">
              <li>One-hot (safe baseline for nominal) — may inflate dims.</li>
              <li>Ordinal codes (for trees) — don’t imply false order.</li>
              <li>Target/mean enc. — powerful; must be CV-folded to avoid leakage.</li>
            </ul>
          </li>
          <li>Class imbalance: class weights, SMOTE/undersample, thresholds, PR-AUC.</li>
          <li>Text: TF-IDF/embeddings; lower/stopwords per task; handle OOV.</li>
          <li>Time series: no shuffling; windowed scaling if distribution drifts.</li>
        </ul>
      </div>
    </section>

    <section id="fe" class="theory-card card rounded-2xl border bg-white p-4 shadow-sm dark:bg-gray-900 dark:border-gray-700"
             data-title="feature engineering domain transforms log binning interactions time features pca umap tsne" data-order="4">
      <header class="flex items-start justify-between gap-3 cursor-pointer select-none accordion-toggle">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl grid place-items-center bg-gradient-to-br from-amber-500 to-pink-500 text-white text-lg shadow-sm">🧬</div>
          <h2 class="text-lg font-semibold">4) Feature Engineering (add signal, reduce noise)</h2>
        </div>
        <div class="flex items-center gap-2">
          <span class="status-badge text-[11px] text-gray-500 border rounded-full px-2 py-0.5">Unread</span>
          <span class="chev transition">▶</span>
        </div>
      </header>
      <div class="accordion-body mt-3 hidden">
        <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 space-y-1">
          <li>Domain features: ratios, rates, meaningful thresholds.</li>
          <li>Transforms: log for heavy tails; binning for monotonic trends; polynomials for simple nonlinearity.</li>
          <li>Interactions: explicit crosses (A×B) or let trees/boosting learn them.</li>
          <li>Time features: lags, rolling stats, time-since-event — preserve temporal order.</li>
          <li>Dimensionality reduction: PCA for compression/denoising; UMAP/t-SNE for visualization.</li>
        </ul>
      </div>
    </section>

    <section id="fs" class="theory-card card rounded-2xl border bg-white p-4 shadow-sm dark:bg-gray-900 dark:border-gray-700"
             data-title="feature selection filter wrapper embedded variance correlation rfe l1 l2 permutation" data-order="5">
      <header class="flex items-start justify-between gap-3 cursor-pointer select-none accordion-toggle">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl grid place-items-center bg-gradient-to-br from-cyan-500 to-indigo-500 text-white text-lg shadow-sm">🎯</div>
          <h2 class="text-lg font-semibold">5) Feature Selection (keep what matters)</h2>
        </div>
        <div class="flex items-center gap-2">
          <span class="status-badge text-[11px] text-gray-500 border rounded-full px-2 py-0.5">Unread</span>
          <span class="chev transition">▶</span>
        </div>
      </header>
      <div class="accordion-body mt-3 hidden">
        <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 space-y-1">
          <li>Filter: variance threshold; correlation prune (drop one of highly correlated pairs).</li>
          <li>Wrapper: RFE with CV; greedy forward/backward (costly).</li>
          <li>Embedded: L1/L2 regularization, tree importances, permutation importance (robust, model-agnostic).</li>
          <li>Start light — over-pruning can remove useful interactions.</li>
        </ul>
      </div>
    </section>

    <section id="validation" class="theory-card card rounded-2xl border bg-white p-4 shadow-sm dark:bg-gray-900 dark:border-gray-700"
             data-title="splits validation kfold stratified group time series metrics" data-order="6">
      <header class="flex items-start justify-between gap-3 cursor-pointer select-none accordion-toggle">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl grid place-items-center bg-gradient-to-br from-green-500 to-blue-500 text-white text-lg shadow-sm">🧪</div>
          <h2 class="text-lg font-semibold">6) Splitting & Validation (measure generalization)</h2>
        </div>
        <div class="flex items-center gap-2">
          <span class="status-badge text-[11px] text-gray-500 border rounded-full px-2 py-0.5">Unread</span>
          <span class="chev transition">▶</span>
        </div>
      </header>
      <div class="accordion-body mt-3 hidden">
        <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 space-y-1">
          <li>Keep a final holdout test; tune via K-fold/Stratified K-fold on train.</li>
          <li>Respect groups/sessions/users (GroupKFold) to avoid leakage.</li>
          <li>Time series: rolling/expanding windows; never peek into the future.</li>
          <li>Pick metrics aligned to objective (PR-AUC/F1 for rare positives; AUC for ranking; calibration if probs matter).</li>
        </ul>
      </div>
    </section>

    <section id="leakage" class="theory-card card rounded-2xl border bg-white p-4 shadow-sm dark:bg-gray-900 dark:border-gray-700"
             data-title="leakage post-event features global encoding future info" data-order="7">
      <header class="flex items-start justify-between gap-3 cursor-pointer select-none accordion-toggle">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl grid place-items-center bg-gradient-to-br from-rose-500 to-orange-500 text-white text-lg shadow-sm">🚫</div>
          <h2 class="text-lg font-semibold">7) Leakage (the silent model killer)</h2>
        </div>
        <div class="flex items-center gap-2">
          <span class="status-badge text-[11px] text-gray-500 border rounded-full px-2 py-0.5">Unread</span>
          <span class="chev transition">▶</span>
        </div>
      </header>
      <div class="accordion-body mt-3 hidden">
        <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 space-y-1">
          <li>Post-event fields, manual labels not available at inference, future timestamps in train.</li>
          <li>Global encoders fit on full data (target encoding without CV) → inflated validation.</li>
          <li>Always mirror deployment data flow during training & validation.</li>
        </ul>
      </div>
    </section>

    <section id="robust" class="theory-card card rounded-2xl border bg-white p-4 shadow-sm dark:bg-gray-900 dark:border-gray-700"
             data-title="robustness pipelines seeds logging monitoring drift reproducibility" data-order="8">
      <header class="flex items-start justify-between gap-3 cursor-pointer select-none accordion-toggle">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl grid place-items-center bg-gradient-to-br from-slate-500 to-zinc-700 text-white text-lg shadow-sm">🛡️</div>
          <h2 class="text-lg font-semibold">8) Robustness & Reproducibility</h2>
        </div>
        <div class="flex items-center gap-2">
          <span class="status-badge text-[11px] text-gray-500 border rounded-full px-2 py-0.5">Unread</span>
          <span class="chev transition">▶</span>
        </div>
      </header>
      <div class="accordion-body mt-3 hidden">
        <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 space-y-1">
          <li>Pipelines: package preprocessors + model so inference = training.</li>
          <li>Seeds & logging: set random_state; log data versions/params/metrics; save artifacts.</li>
          <li>Monitoring: input/target drift, data quality, performance decay; plan retraining.</li>
        </ul>
      </div>
    </section>

    <!-- Next steps -->
    <section class="rounded-2xl border bg-white p-4 shadow-sm dark:bg-gray-900 dark:border-gray-700">
      <h2 class="text-lg font-semibold mb-3">Next steps</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <a href="{{ url_for('process') }}" class="block border rounded-xl p-3 hover:bg-gray-50 dark:hover:bg-gray-800 dark:border-gray-700">
          <div class="font-semibold mb-1">Process (Hands-on)</div>
          <p class="text-sm text-gray-600 dark:text-gray-400">End-to-end skeleton with one-line code hints.</p>
        </a>
        <a href="{{ url_for('mindmap') }}" class="block border rounded-xl p-3 hover:bg-gray-50 dark:hover:bg-gray-800 dark:border-gray-700">
          <div class="font-semibold mb-1">Interactive Mind Map</div>
          <p class="text-sm text-gray-600 dark:text-gray-400">Models, parameters, search & voice.</p>
        </a>
        <a href="{{ url_for('intro') }}" class="block border rounded-xl p-3 hover:bg-gray-50 dark:hover:bg-gray-800 dark:border-gray-700">
          <div class="font-semibold mb-1">Intro Recap</div>
          <p class="text-sm text-gray-600 dark:text-gray-400">Review core concepts and when to use ML.</p>
        </a>
      </div>
    </section>
  </div>
</div>

<!-- Page scripts -->
<script>
  // --- Dark mode toggle (persist) ---
  (function () {
    const root = document.documentElement;
    const saved = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (saved ? saved === 'dark' : prefersDark) root.classList.add('dark');
    document.getElementById('themeToggle')?.addEventListener('click', () => {
      root.classList.toggle('dark');
      const isDark = root.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
  })();

  // --- Build TOC, ScrollSpy, Accordion, Progress, Search, Tilt ---
  (function () {
    const cards = Array.from(document.querySelectorAll('.theory-card'));
    const toc = document.getElementById('toc');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const markAllBtn = document.getElementById('markAll');
    const resetAllBtn = document.getElementById('resetAll');

    // State in localStorage
    const KEY_STATE = 'theory_state_v1';
    const state = JSON.parse(localStorage.getItem(KEY_STATE) || '{}'); // {id: {open:bool, done:bool}}

    const save = () => localStorage.setItem(KEY_STATE, JSON.stringify(state));

    // Build TOC
    cards.sort((a,b)=> (+a.dataset.order || 0) - (+b.dataset.order || 0));
    cards.forEach((card, idx) => {
      const id = card.id;
      const title = card.querySelector('h2')?.textContent?.trim() || `Section ${idx+1}`;
      const a = document.createElement('a');
      a.href = `#${id}`;
      a.textContent = title;
      a.className = 'block rounded px-2 py-1 hover:bg-gray-50 dark:hover:bg-gray-800';
      a.dataset.target = id;
      toc.appendChild(a);

      // restore open/done
      const saved = state[id] || {};
      const body = card.querySelector('.accordion-body');
      const chev = card.querySelector('.chev');
      const badge = card.querySelector('.status-badge');
      const open = saved.open ?? (idx === 0); // first open by default
      const done = saved.done ?? false;
      if (open) { body?.classList.remove('hidden'); chev && (chev.style.transform = 'rotate(90deg)'); }
      if (done) { badge?.classList.add('text-green-700','border-green-200'); badge.textContent = 'Done ✓'; }

      // accordion toggle
      card.querySelector('.accordion-toggle')?.addEventListener('click', () => {
        const visible = !body.classList.contains('hidden');
        body.classList.toggle('hidden');
        chev.style.transform = visible ? 'rotate(0deg)' : 'rotate(90deg)';
        state[id] = state[id] || {};
        state[id].open = !visible;
        save();
      });

      // mark done on scroll into view (threshold)
      const io = new IntersectionObserver((entries) => {
        entries.forEach(ent => {
          if (ent.isIntersecting) {
            state[id] = state[id] || {};
            if (!state[id].done) {
              state[id].done = true;
              badge?.classList.add('text-green-700','border-green-200');
              badge.textContent = 'Done ✓';
              updateProgress();
              save();
            }
          }
        });
      }, { threshold: 0.6 });
      io.observe(card);
    });

    // ScrollSpy
    const tocLinks = Array.from(toc.querySelectorAll('a'));
    const spy = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        const id = e.target.id;
        const link = tocLinks.find(l => l.dataset.target === id);
        if (e.isIntersecting) {
          tocLinks.forEach(l => l.classList.remove('bg-gray-100','dark:bg-gray-800','font-semibold'));
          link?.classList.add('bg-gray-100','dark:bg-gray-800','font-semibold');
        }
      });
    }, { rootMargin: '-40% 0% -55% 0%' });
    cards.forEach(c => spy.observe(c));

    // Progress
    function updateProgress() {
      const total = cards.length;
      const done = cards.filter(c => (state[c.id]?.done)).length;
      const pct = total ? Math.round((done / total) * 100) : 0;
      progressBar.style.width = pct + '%';
      progressText.textContent = `${done} of ${total} completed`;
    }
    updateProgress();

    // Mark all / reset
    markAllBtn?.addEventListener('click', () => {
      cards.forEach(c => {
        const badge = c.querySelector('.status-badge');
        state[c.id] = state[c.id] || {};
        state[c.id].done = true;
        badge?.classList.add('text-green-700','border-green-200');
        badge.textContent = 'Done ✓';
      });
      updateProgress(); save();
    });
    resetAllBtn?.addEventListener('click', () => {
      cards.forEach(c => {
        const badge = c.querySelector('.status-badge');
        state[c.id] = state[c.id] || {};
        state[c.id].done = false;
        badge?.classList.remove('text-green-700','border-green-200');
        badge.textContent = 'Unread';
      });
      updateProgress(); save();
    });

    // Search filter + Cmd/Ctrl+K focus
    const input = document.getElementById('searchInput');
    function applyFilter() {
      const q = (input.value || '').trim().toLowerCase();
      cards.forEach(c => {
        const hay = (c.getAttribute('data-title') || '').toLowerCase() + ' ' + (c.querySelector('h2')?.textContent||'').toLowerCase();
        c.style.display = hay.includes(q) ? '' : 'none';
      });
    }
    input?.addEventListener('input', applyFilter);
    window.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault(); input?.focus();
      }
    });

    // 3D hover tilt
    const tiltCards = document.querySelectorAll('.card');
    tiltCards.forEach(card => {
      const r = 10;
      card.addEventListener('mousemove', (e) => {
        const rect = card.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top) / rect.height;
        const rx = (0.5 - y) * r;
        const ry = (x - 0.5) * r;
        card.style.transform = `perspective(800px) rotateX(${rx}deg) rotateY(${ry}deg) translateY(-2px)`;
      });
      ['mouseleave','blur'].forEach(evt =>
        card.addEventListener(evt, () => card.style.transform = 'translateY(-2px)'));
      card.classList.add('transition');
    });
  })();
</script>
{% endblock %}
